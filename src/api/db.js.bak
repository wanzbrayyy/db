import { generateNanoId } from '../utils/uuid';

// URL Backend Vercel
const API_URL = 'https://dbw-nu.vercel.app/api/data';

// Helper Cerdas: Cek apakah respon JSON atau Text
const handleResponse = async (res) => {
  const contentType = res.headers.get("content-type");
  
  if (contentType && contentType.includes("application/json")) {
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.error || data.message || data.msg || "API Request Failed");
    }
    return data;
  } else {
    // Jika backend mengirim "Server error" (Text HTML/Plain)
    const text = await res.text();
    // Jika error text pendek, tampilkan. Jika HTML panjang (error Vercel), tampilkan generik.
    const errorMessage = text.length < 100 ? text : `Server Error (${res.status})`;
    throw new Error(errorMessage);
  }
};

export const DB = {
  // --- Collection Management ---

  getCollections: async () => {
    try {
      const res = await fetch(`${API_URL}/collections`);
      const data = await handleResponse(res);
      
      // Validasi wajib array
      if (!Array.isArray(data)) {
        console.warn("API did not return an array:", data);
        return []; 
      }
      return data;
    } catch (error) {
      console.error("DB Error:", error);
      return []; // Return array kosong biar gak crash
    }
  },

  createCollection: async (name) => {
    if (!name) throw new Error("Collection name is required");

    const res = await fetch(`${API_URL}/collections`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    
    return await handleResponse(res);
  },

  deleteCollection: async (name) => {
    const res = await fetch(`${API_URL}/collections/${name}`, { 
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    return await handleResponse(res);
  },

  // --- Document CRUD ---

  find: async (collection) => {
    try {
      const res = await fetch(`${API_URL}/${collection}`);
      if (res.status === 404) return [];
      
      const data = await handleResponse(res);
      return Array.isArray(data) ? data : [];
    } catch (error) {
      console.error(`Find Error in ${collection}:`, error);
      return [];
    }
  },

  findOne: async (collection, predicate) => {
    if (typeof predicate === 'function') {
      throw new Error("Invalid predicate. Use object: { email: '...' }");
    }

    const res = await fetch(`${API_URL}/${collection}/find-one`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(predicate)
    });

    if (res.status === 404) return null;
    
    // Khusus findOne, kadang return null (bukan JSON error)
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  },

  findById: async (collection, id) => {
    const res = await fetch(`${API_URL}/${collection}/${id}`);
    if (res.status === 404) return null;
    return await handleResponse(res);
  },

  insert: async (collection, data) => {
    const newItem = {
      _id: generateNanoId(50), 
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      ...data
    };

    const res = await fetch(`${API_URL}/${collection}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newItem)
    });

    return await handleResponse(res);
  },

  update: async (collection, id, updates) => {
    const res = await fetch(`${API_URL}/${collection}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updates)
    });

    return await handleResponse(res);
  },

  remove: async (collection, id) => {
    const res = await fetch(`${API_URL}/${collection}/${id}`, { 
      method: 'DELETE' 
    });

    return await handleResponse(res);
  }
};